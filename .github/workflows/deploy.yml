name: "deploy"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    tags-ignore: [ "**" ]

concurrency:
  group: ${{ github.ref }}-build
  cancel-in-progress: true

jobs:
  build:
    runs-on: "ubuntu-latest"
    environment:
      name: "production"
      url: "https://webui.advntr.dev"
    steps:
      - name: "setup env"
        id: "setup"
        uses: "KyoriPowered/.github/.github/actions/setup-java-env@trunk"
        with:
          runtime_version: 21
          publishing_branch_regex: "main"
          gradle_warning_mode: "all"
      - name: "build for production"
        run: "./gradlew build"
      - name: "setup / login to ghcr"
        uses: "docker/login-action@v3.4.0"
        with:
          registry: "ghcr.io"
          username: "${{ github.actor }}"
          password: "${{ secrets.GITHUB_TOKEN }}"
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/kyoripowered/adventure-webui/webui
          tags: |
            type=sha,enable=true,format=short,prefix=${{ env.BRANCH_NAME }}-,suffix=-${{ steps.timestamp.outputs.timestamp }}
            type=raw,value=latest,enable={{is_default_branch}}
      - name: "publish / docker image"
        run: "./gradlew jib -Djib.console=plain -Djib.to.tags=${{ steps.meta.outputs.tags }} -Djib.container.labels=${{ steps.meta.outputs.labels }}"
